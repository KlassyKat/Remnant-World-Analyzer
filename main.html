<link rel="stylesheet" href="./styles/main.css">

<body>
    <nav class="control-bar">
        <svg width="12px" viewBox="0 0 16 32" version="1.1" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/"
            style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
            <path
                d="M15.77,9.825l-7.659,-9.825l-5.999,8.627c-0,-0 2.331,4.394 3.4,5.282c0.772,0.642 2.354,0.36 3.012,0.048c1.91,-0.905 2.043,-5.309 1.359,-6.468c-0.388,-0.656 -2.31,0.121 -2.859,1.467c-0.586,1.433 1.966,2.043 2.041,2.291c0.411,1.362 -3.016,0.845 -3.461,-2.035c-0.159,-1.026 2.09,-3.543 2.964,-3.775c0.875,-0.231 2.289,1.164 2.501,2.269c0.29,1.513 -0.066,5.073 -1.079,6.432c-0.985,1.32 -2.357,1.53 -3.833,1.398c-1.685,-0.151 -4.742,-5.908 -4.742,-5.908l-1.415,2.035l2.526,15.523l5.629,4.814l2.228,-1.723c-0,-0 -4.263,-5.068 -4.636,-6.963c-0.279,-1.419 1.588,-3.886 2.777,-4.119c1.189,-0.233 2.743,0.392 3.359,1.434c0.617,1.042 0.279,3.128 -0.312,3.695c-0.592,0.567 -2.811,0.897 -2.944,-0.367c-0.06,-0.565 3.162,1.119 2.705,-2.338c-0.068,-0.514 -1.958,-1.801 -2.695,-1.533c-0.737,0.267 -2.274,2.387 -1.91,3.336c0.549,1.429 4.836,5.941 4.836,5.941l3.057,-2.364l1.15,-17.174Z"
                style="fill:#ad433e;" />
        </svg>
        <strong class="title">Remnant World Analyzer</strong>
        <span onclick="minimizeWindow()" class="minimize-window">
            <svg viewBox="0 0 32 32">
                <line x1="0" y1="17" x2="32" y2="17" />
            </svg>
        </span>
        <span onclick="maximizeWindow()" class="maximize-window">
            <svg viewBox="0 0 32 32">
                <line x1="0" y1="4" x2="32" y2="4" style="stroke-width: 8"></line>
                <line x1="0" y1="28" x2="32" y2="28"></line>
                <line x1="0" y1="28" x2="0" y2="4"></line>
                <line x1="32" y1="28" x2="32" y2="4"></line>
            </svg>
        </span>
        <span onclick="closeWindow()" class="close-window">
            <svg viewBox="0 0 32 32">
                <line x1="2" y1="2" x2="30" y2="30" />
                <line x1="2" y1="30" x2="30" y2="2" />
            </svg>
        </span>
    </nav>

    <div class="container">
        <div class="setting-wrapper">
            <!-- <input type="file" onchange="loadFile(this)" id="file-selector"> -->
            <!-- <div id="save-files-wrapper">
                <span id="file-placeholder" class="save-file" onclick="changeActiveFile(this)"></span>
            </div> -->
            <div class="mode-select-wrapper">
                <span id="campaign-mode" class="mode-select" onclick="swapWorldMode('campaign')">Campaign</span>
                <span id="adventure-mode" class="mode-select mode-select_active"
                    onclick="swapWorldMode('adventure')">Adventure</span>
            </div>
            <div class="update-wrapper">
                <button class="update-button">
                    <svg viewBox="0 0 32 32"
                        style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
                        <path
                            d="M27.667,18.521c-1.159,5.378 -5.945,9.413 -11.667,9.413c-5.722,-0 -10.508,-4.035 -11.667,-9.413l3.077,-0c1.09,3.714 4.525,6.429 8.59,6.429c4.065,0 7.5,-2.715 8.59,-6.429l3.077,-0Z"
                            style="fill:#fff;" />
                        <path
                            d="M4.333,13.479c1.159,-5.378 5.945,-9.413 11.667,-9.413c5.722,0 10.508,4.035 11.667,9.413l-3.077,0c-1.09,-3.714 -4.525,-6.429 -8.59,-6.429c-4.065,-0 -7.5,2.715 -8.59,6.429l-3.077,0Z"
                            style="fill:#fff;" />
                        <path d="M9.696,18.195l-4.696,-2.195l-2.194,4.696l6.89,-2.501Z" style="fill:#fff;" />
                        <path d="M22.363,13.805l4.697,2.195l2.194,-4.696l-6.891,2.501Z" style="fill:#fff;" /></svg>
                    Update
                </button>
            </div>
            <div class="color-wrapper">
                <input type="checkbox" name="color-coated" id="color-checkbox" onchange="colorCoat()">
                <label for="color-coated">Color Coated</label>
            </div>
        </div>

        <div class="event-wrapper">
            <div class="table">
                <div class="header-row">
                    <span class="header check"></span>
                    <span class="header">Location</span>
                    <span class="header">Event Type</span>
                    <span class="header">Event Name</span>
                </div>
                <div id="data-wrapper">
                    <div class="data-row" id="placeholder">
                        <span class="data-item check" onclick="checkOff(this)">
                            <svg viewBox="0 0 32 32" class="check-mark">
                                <path d="m 4 16 l 4 4 l 8 -8" stroke="white" stroke-width="3" fill="none"></path>
                            </svg>
                        </span>
                        <span class="data-item"></span>
                        <span class="data-item"></span>
                        <span class="data-item event-name" onclick="wikiLink(this)"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script src="./scripts/processFiles.js"></script>
<script src="./scripts/characters.js"></script>
<script>
    let {
        sublocations,
        mainLocations,
        eventNames
    } = require('./scripts/remnant.format.js');
    let textArray = [];
    let adventureArray = [];
    let worldMode = "adventure";
    let allEvents = [];

    let colorCoated = false;

    // CONTROLS

    function minimizeWindow() {
        ipcRenderer.send("minimize-window");
    }

    function maximizeWindow() {
        ipcRenderer.send("maximize-window");
    }

    function closeWindow() {
        ipcRenderer.send("close-main-window");
    }

    function swapWorldMode(mode) {
        let campaignActive = document.getElementById('campaign-mode');
        let adventureActive = document.getElementById('adventure-mode');
        if (mode == 'adventure' && worldMode != 'adventure') {
            campaignActive.classList.remove('mode-select_active');
            adventureActive.classList.add('mode-select_active');
            worldMode = 'adventure';
            clearEvents();
            getWorldData(worldMode);
        } else if (mode == 'campaign' && worldMode != 'campaign') {
            adventureActive.classList.remove('mode-select_active');
            campaignActive.classList.add('mode-select_active');
            worldMode = 'campaign';
            clearEvents();
            getWorldData(worldMode);
        }
    }

    // let saveFilesPath;
    // let saveFiles = [];
    // let activeFile;
    // let fileWrapper = document.getElementById('save-files-wrapper');
    // ipcRenderer.send('get-file-path');
    // ipcRenderer.on('file-path', (e, payload) => {
    //     saveFilesPath = payload[1];
    //     saveFiles = payload[2];
    //     for (file of saveFiles) {
    //         if (String(file).includes('.sav') && !String(file).includes('profile')) {
    //             createSaveFileTiles(file);
    //             activeFile = file;
    //         }
    //     }
    //     fileWrapper.lastChild.classList.add('save-file_active');
    //     chooseSave(activeFile);
    // })

    function changeActiveFile(e) {
        console.log(e);
        if (!e.classList.contains('save-file_active')) {
            for (child of e.parentNode.children) {
                console.log(child)
                child.classList.remove('save-file_active');
            }
            e.classList.add('save-file_active');
            activeFile = e.id;
            clearEvents();
            chooseSave(activeFile);
        }

    }

    function chooseSave(file) {
        ipcRenderer.send('choose-save', `${saveFilesPath}/${file}`);
    }

    ipcRenderer.on('file-update', (e, payload) => {
        cleanData(payload);
    })

    function checkOff(e) {
        if (!e.parentNode.classList.contains('checked-off')) {
            e.parentNode.classList.add('checked-off')
            e.parentNode.style.color = RGBToHex(e.parentNode.style.color) + '44';
            e.children[0].style.opacity = 1;
        } else {
            e.parentNode.classList.remove('checked-off');
            e.parentNode.style.color = e.parentNode.style.color.replace(', 0.267', '');
            e.children[0].style.opacity = 0;
        }




        function RGBToHex(rgb) {
            // Choose correct separator
            let sep = rgb.indexOf(",") > -1 ? "," : " ";
            // Turn "rgb(r,g,b)" into [r,g,b]
            rgb = rgb.substr(4).split(")")[0].split(sep);

            let r = (+rgb[0]).toString(16),
                g = (+rgb[1]).toString(16),
                b = (+rgb[2]).toString(16);

            if (r.length == 1)
                r = "0" + r;
            if (g.length == 1)
                g = "0" + g;
            if (b.length == 1)
                b = "0" + b;

            return "#" + r + g + b;
        }
    }

    function colorCoat() {
        let checkbox = document.getElementById('color-checkbox');
        if (checkbox.checked) {
            colorCoated = true;
        } else {
            colorCoated = false;
        }
        clearEvents();
        getWorldData(worldMode);
    }

    function createSaveFileTiles(file) {
        let filePrime = document.getElementById('file-placeholder');
        let newFileTile = filePrime.cloneNode(true);
        newFileTile.id = file;
        newFileTile.innerHTML = file;
        fileWrapper.appendChild(newFileTile);
    }

    function cleanData(e) {
        let text = e
        // Get save portion for campaign
        text = text.split("/Game/Campaign_Main/Quest_Campaign_Ward13.Quest_Campaign_Ward13")[0];
        text = text.split("/Game/Campaign_Main/Quest_Campaign_City.Quest_Campaign_City")[1].replace(/Game/g, "\n");

        textArray = text.split("\n");

        let adventureText = e.split("\n");

        tempList = [];
        for (event of adventureText) {
            if (String(event).includes('Adventure')) {
                tempList.push(event);
            }
        }
        adventureText = tempList[1];
        adventureText = adventureText.replace(/Game/g, "\n")
        adventureArray = adventureText.split("\n")

        getWorldData(worldMode);
    }

    function getWorldData(worldMode) {
        let data;
        if (worldMode == 'adventure') {
            data = adventureArray;
        } else {
            data = textArray;
        }

        allEvents = [];
        let zones = {};

        zones["Earth"] = {};
        zones["Rhom"] = {};
        zones["Yaesha"] = {};
        zones["Corsus"] = {};

        let currentMainLocation;

        if (worldMode == "adventure") {
            //May need reworked
            currentMainLocation = data[3].split('/')[1].split('_')[1];
        } else {
            currentMainLocation = "Fairview"
        }

        let currentSublocation = "";

        for (i in data) {
            let zone;
            let eventType;
            let eventName;
            let lastEventName;
            let isSmallDungeon = true;

            let textLine = data[i];

            //translate world/region names to readable text
            let textString = String(textLine);
            if (textString.includes("World_City")) {
                zone = "Earth"
            }
            if (textString.includes("World_Wasteland")) {
                zone = "Rhom"
            }
            if (textString.includes("World_Swamp")) {
                zone = "Corsus"
            }
            if (textString.includes("World_Jungle")) {
                zone = "Yaesha"
            }
            if (textString.includes("World_Snow")) {
                zone = "Resium"
            }

            lastEventname = eventName;

            //look for side dungeons
            if (textString.includes("SmallD")) {
                eventType = "Side Dungeon"
                eventName = textLine.split("/")[3].split("_")[2]
                currentSublocation = sublocations[eventName]
                if (currentSublocation == undefined) {
                    currentSublocation = "Not added yet"
                }
                eventNames[eventName] ? eventName = eventNames[eventName] : eventName = eventName;
                inSmallDungeon = true
            }

            //look for overworld POI's
            if (textLine.search("OverworldPOI") != -1) {
                eventType = "Point of Interest"
                eventName = textLine.split("/")[3].split("_")[2]
                currentSublocation = currentMainLocation
                if (worldMode == "#adventure") {
                    currentSublocation = ''
                }
                if (currentSublocation == undefined) {
                    currentSublocation = "Not added yet"
                }
                eventNames[eventName] ? eventName = eventNames[eventName] : eventName = eventName;
                inSmallDungeon = true
            }

            //Look for quest bosses
            if (textLine.search("Quest_Boss") != -1) {
                eventType = "World Boss"
                eventName = textLine.split("/")[3].split("_")[2]
                currentSublocation = sublocations[eventName];
                eventNames[eventName] ? eventName = eventNames[eventName] : eventName = eventName;
                if (currentSublocation == undefined) {
                    currentSublocation = "Not added yet"
                }
            }

            //look for sieges
            if (textLine.search("Siege") != -1) {
                eventType = "Siege"
                eventName = textLine.split("/")[3].split("_")[2]
                currentSublocation = sublocations[eventName]
                eventNames[eventName] ? eventName = eventNames[eventName] : eventName = eventName;
                if (currentSublocation == undefined) {
                    currentSublocation = "Not added yet"
                }
            }

            //look for minibosses
            if (textLine.search("Mini") != -1) {
                eventType = "Miniboss"
                eventName = textLine.split("/")[3].split("_")[2]
                currentSublocation = sublocations[eventName];
                eventNames[eventName] ? eventName = eventNames[eventName] : eventName = eventName;
                if (currentSublocation == undefined) {
                    currentSublocation = "Not added yet"
                }
            }

            //look for Item drops
            if (textLine.search("Quest_Event") != -1) {
                eventType = "Item Drop"
                eventName = textLine.split("/")[3].split("_")[2]

                // edge case for out of order items
                if (textLine.split("/")[1].split("_")[1] != textArray[i - 1].split("/")[1].split("_")[1]) {
                    currentSublocation = ''
                }

            }

            if (textLine.search("Overworld_Zone") != -1) {
                currentMainLocation = textLine.split("/")[3].split("_")[1] + " " + textLine.split("/")[3].split("_")[
                    2] + " " + textLine.split("/")[3].split("_")[3]
                currentMainLocation = mainLocations[currentMainLocation]
            }

            //Renames the bosses
            if (eventName != lastEventname) {
                // Replacements
                eventNames[eventName] ? eventName = eventNames[eventName] : eventName = eventName;
                //This populates the table for data to be pulled
                if (zone != undefined && eventType != undefined && eventName != undefined) {
                    let event = {
                        MainLocation: currentMainLocation,
                        SubLocation: currentSublocation,
                        Zone: zone,
                        EventType: eventType,
                        EventName: eventName
                    }
                    createEventTile(event)
                }
            }
        }
    }

    function clearEvents() {
        let textArray = [];
        let adventureArray = [];
        let allEvents = [];
        let dataWrapper = document.getElementById('data-wrapper');
        let dataEvents = dataWrapper.children;
        while (dataEvents.length > 1) {
            dataWrapper.lastChild.remove();
        }
    }


    function createEventTile(payload) {
        if (allEvents.indexOf(payload.EventName) == -1 || payload.EventName == 'TraitBook') {
            allEvents.push(payload.EventName);

            let eventTilePrime = document.getElementById("placeholder");
            let newTile = eventTilePrime.cloneNode(true);
            newTile.id = payload.EventName;

            let tileLocation = document.createTextNode(payload.Zone + ' > ' + payload.SubLocation.split(/(?=[A-Z])/)
                .join(
                    ' '));
            let tileEventType = document.createTextNode(payload.EventType);
            let tileEventName = document.createTextNode(payload.EventName.split(/(?=[A-Z])/).join(' '));
            newTile.children[1].appendChild(tileLocation);
            newTile.children[2].appendChild(tileEventType);
            newTile.children[3].appendChild(tileEventName);

            if (colorCoated) {
                switch (payload.EventType) {
                    case 'Item Drop':
                        newTile.style.color = '#256ab9';
                        console.log('working')
                        break;
                    case 'World Boss':
                        newTile.style.color = '#b60c00';
                        break;
                    case 'Siege':
                        newTile.style.color = '#F0F01A';
                        break;
                    case 'Miniboss':
                        newTile.style.color = '#ffa500';
                        break;
                    case 'Point of Interest':
                        newTile.style.color = '#008000';
                        break;
                    default:
                        newTile.style.color = '#ffffff';
                        break;
                }
            } else {
                newTile.style.color = '#ebebeb'
            }

            document.getElementById('data-wrapper').appendChild(newTile);
        }
    }

    function wikiLink(e) {
        let item = e.innerHTML;
        item = item.replace(/\s/g, '+')
        console.log(item)
        shell.openExternal('https://remnantfromtheashes.wiki.fextralife.com/' + item)
    }
</script>